<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLC Portal - Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body class="bg-gray-50">
    <nav class="bg-indigo-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-university text-2xl mr-2"></i>
                        <span class="font-bold text-xl">CLC Portal</span>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:items-center md:space-x-4">
                        <a href="StudentDashboard.html" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-900">Dashboard</a>
                        <a href="Seat/Seat.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Seat Matrix</a>
                        <a href="BranchPreference/index.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Add Preference</a>
                        <a href="StudentProfile.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Profile</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex items-center">
                        <span class="mr-4 text-sm" data-user-fullname>John Doe</span>
                        <button data-logout-button class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile menu, show/hide based on menu state -->
    <div class="md:hidden">
        <div class="bg-indigo-700 px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a href="StudentDashboard.html" class="block px-3 py-2 rounded-md text-base font-medium bg-indigo-900">Dashboard</a>
            <a href="Seat/Seat.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-700">Seat Matrix</a>

            <a href="BranchPreference/index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-700">Add Preference</a>
            <a href="StudentProfile.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-indigo-700">Profile</a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Status card -->
        <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                        <i class="fas fa-user-graduate text-white text-xl"></i>
                    </div>
                    <div class="ml-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Current Admission Status</h3>
                        <div class="mt-2 max-w-xl text-sm text-gray-500">
                            <p data-admission-status>Your rank is currently being processed for counselling.</p>
                        </div>
                    </div>
                    <div class="ml-auto">
                        <span id="admission-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock mr-1"></i> In Queue
                        </span>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-4 sm:px-6">
                <div class="text-sm">
                    <span class="font-medium text-gray-700">Your Current Rank:</span>
                    <span data-current-rank class="ml-2 font-bold text-indigo-600">145</span>
                    <span class="ml-4 font-medium text-gray-700">Students Ahead of You:</span>
                    <span data-students-ahead class="ml-2 font-bold text-indigo-600">8</span>
                </div>
            </div>
        </div>

        <!-- Grid layout for cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Your Details -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Your Details</h3>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <dl class="space-y-2">
                        <div class="sm:grid sm:grid-cols-3 sm:gap-4">
                            <dt class="text-sm font-medium text-gray-500">Full name</dt>
                            <dd data-user-fullname class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">John Doe</dd>
                        </div>
                        <div class="sm:grid sm:grid-cols-3 sm:gap-4">
                            <dt class="text-sm font-medium text-gray-500">Roll number</dt>
                            <dd data-user-rollnumber class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">EX-2023-45678</dd>
                        </div>
                        <div class="sm:grid sm:grid-cols-3 sm:gap-4">
                            <dt class="text-sm font-medium text-gray-500">Rank</dt>
                            <dd data-user-rank class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">145</dd>
                        </div>
                        <div class="sm:grid sm:grid-cols-3 sm:gap-4">
                            <dt class="text-sm font-medium text-gray-500">Category</dt>
                            <dd data-user-category class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">General</dd>
                        </div>
                    </dl>
                </div>
            </div>
            
            <!-- Counselling Schedule -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Counselling Schedule</h3>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-500">Estimated Date</span>
                            <span data-counselling-date class="text-sm font-bold text-indigo-600">March 25, 2025</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-500">Reporting Time</span>
                            <span data-counselling-time class="text-sm font-bold text-indigo-600">10:00 AM</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Venue</span>
                            <span data-counselling-venue class="text-sm font-bold text-indigo-600">Main Auditorium</span>
                        </div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                        <p class="text-xs text-yellow-700">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Please bring all original documents and their photocopies for verification.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Required Documents -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Required Documents</h3>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <ul class="space-y-2">
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Qualifying Exam Marksheet</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Rank Card / Certificate</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">ID Proof (Aadhar/PAN)</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Category Certificate (if applicable)</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">4 Passport Size Photographs</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-gray-700">Migration Certificate</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Top 15 Rankings -->
        <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
            <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Current Top 15 Rankings</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll Number</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="bg-gray-100 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                © 2025 College Level Counselling Portal. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
// Ensure rollNumber is stored from token
function storeRollNumberFromToken() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('❌ Token not found in localStorage.');
        return;
    }

    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.username) {
            localStorage.setItem('rollNumber', payload.username);
            console.log('✅ Stored rollNumber:', payload.username);
        } else {
            console.error('❌ Username missing in token payload.');
        }
    } catch (error) {
        console.error('❌ Error decoding token:', error);
    }
}

storeRollNumberFromToken(); 

// Function to append rollNumber to links
function appendRollNumberToLinks() {
    const rollNumber = localStorage.getItem('rollNumber');
    if (!rollNumber) return;

    document.querySelectorAll('a').forEach(link => {
        const url = new URL(link.href, window.location.origin);
        url.searchParams.set('rollNumber', rollNumber);
        link.href = url.toString();
    });
}

appendRollNumberToLinks();


        
        let userData = {};

        async function fetchUserDetails() {
            try {
                const rollNumber = localStorage.getItem('rollNumber');
                
                if (!rollNumber) {
                    console.error('Roll number not found in localStorage.');
                    displayErrorMessage('Roll number is missing. Please log in again.');
                    return;
                }
        
                console.log('Fetching student data for rollNumber:', rollNumber); // Debugging log
        
                const response = await fetch(`http://localhost:8080/students/${rollNumber}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
        
                if (!response.ok) {
                    throw new Error(`Failed to fetch user details. Status: ${response.status}`);
                }
        
                userData = await response.json();
                console.log(userData);
                updateUserInterface(userData);
            } catch (error) {
                console.error('Error fetching user details:', error);
                displayErrorMessage('Unable to load user details. Please try again later.');
            }
        }
        
        async function fetchCounsellingSchedule() {
            try {
                // Hardcoded counselling schedule
                const scheduleData = {
                    date: 'March 25, 2025',
                    time: '10:00 AM',
                    venue: 'Main Auditorium'
                };
                updateCounsellingSchedule(scheduleData);
            } catch (error) {
                console.error('Error fetching counselling schedule:', error);
            }
        }
        async function fetchTopRankings() {
            try {
                const response = await fetch('http://localhost:8080/students', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
        
                if (!response.ok) {
                    throw new Error('Failed to fetch top rankings');
                }
        
                const rankingsData = await response.json();
                
                // Sort the rankings data by rank in ascending order
                const sortedRankingsData = rankingsData.sort((a, b) => a.rank - b.rank);
                
                // Update the top rankings table with sorted data
                updateTopRankingsTable(sortedRankingsData);
        
                // Optional: Automatically calculate students ahead if userData is available
                if (userData && userData.rank) {
                    const studentsAhead = rankingsData.filter(student => 
                        student.rank < userData.rank
                    ).length;
        
                    const studentsAheadElement = document.querySelector('[data-students-ahead]');
                    if (studentsAheadElement) {
                        studentsAheadElement.textContent = studentsAhead.toString();
                    }
                }
            } catch (error) {
                console.error('Error fetching top rankings:', error);
            }
        }
        function updateUserInterface(userData) {
            console.log(userData.name);
            document.querySelectorAll('[data-user-fullname]').forEach(el => {
                el.textContent = userData.name || 'John Doe';
            });
            document.querySelector('[data-user-rollnumber]').textContent = userData.rollNumber || 'EX-2023-45678';
            document.querySelector('[data-user-rank]').textContent = userData.rank || '145';
            document.querySelector('[data-user-category]').textContent = userData.category || 'General';

            const admissionStatusElement = document.getElementById('admission-status');
            if (userData.admitted) {
                admissionStatusElement.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Admitted`;
                admissionStatusElement.classList.remove('bg-yellow-100', 'text-yellow-800');
                admissionStatusElement.classList.add('bg-green-100', 'text-green-800');
            } else {
                admissionStatusElement.innerHTML = `<i class="fas fa-clock mr-1"></i> Not Admitted Yet`;
                admissionStatusElement.classList.remove('bg-green-100', 'text-green-800');
                admissionStatusElement.classList.add('bg-yellow-100', 'text-yellow-800');
            }
            document.querySelector('[data-current-rank]').textContent = userData.rank || '145';
            console.log(userData.admitted);
            console.log(userData.admitted);


        }

        function updateCounsellingSchedule(scheduleData) {
            document.querySelector('[data-counselling-date]').textContent = scheduleData.date;
            document.querySelector('[data-counselling-time]').textContent = scheduleData.time;
            document.querySelector('[data-counselling-venue]').textContent = scheduleData.venue;
        }

        function updateTopRankingsTable(rankingsData) {
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = '';
            // Display only the top 15 students
            rankingsData.slice(0, 15).forEach((student, index) => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.rank}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.rollNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                           <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${student.admitted === true ? 'bg-green-100 text-green-800' : 
                                student.admitted === 'In Progress' ? 'bg-blue-100 text-blue-800' : 
                                'bg-yellow-100 text-yellow-800'}">
                                ${student.admitted === true ? 'Admitted' : 
                                student.admitted === 'In Progress' ? 'In Progress' : 'Not Admitted Yet'}
                            </span>

                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        

        function displayErrorMessage(message) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'bg-red-50 p-4 rounded-md mb-4';
            errorContainer.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-400 mr-2"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">${message}</p>
                    </div>
                </div>
            `;
            document.querySelector('.max-w-7xl').insertBefore(errorContainer, document.querySelector('.max-w-7xl').firstChild);
        }

        function toggleMobileMenu() {
            const mobileMenu = document.querySelector('.md\\:hidden');
            mobileMenu.classList.toggle('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchUserDetails();
            fetchCounsellingSchedule();
            fetchTopRankings();
        });

        document.querySelector('[data-logout-button]').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = 'Login/login.html';
        });

    </script>

</body>
</html>